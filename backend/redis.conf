# Redis configuration for Ratetui Rate Limiter
# Optimized for persistence and rate limiting workloads

# ===========================================
# GENERAL
# ===========================================

# Accept connections on all interfaces
bind 0.0.0.0

# Default port
port 6379

# TCP backlog
tcp-backlog 511

# TCP keepalive
tcp-keepalive 300

# Timeout for idle clients (0 = no timeout)
timeout 0

# ===========================================
# PERSISTENCE
# ===========================================

# Enable AOF persistence
appendonly yes
appendfilename "appendonly.aof"

# AOF fsync policy
# no: don't fsync (fastest, but can lose data)
# always: fsync every write (safest, but slow)  
# everysec: fsync every second (good balance - recommended)
appendfsync everysec

# Auto-rewrite AOF when it grows too large
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Enable RDB snapshots as backup
# Save if at least 1 key changed in 900 seconds (15 minutes)
save 900 1
# Save if at least 10 keys changed in 300 seconds (5 minutes)
save 300 10  
# Save if at least 10000 keys changed in 60 seconds
save 60 10000

# RDB filename
dbfilename dump.rdb

# ===========================================
# MEMORY MANAGEMENT
# ===========================================

# Maximum memory (256MB for rate limiting should be sufficient)
maxmemory 256mb

# Eviction policy when memory limit is reached
# allkeys-lru: Remove least recently used keys (good for rate limiting)
maxmemory-policy allkeys-lru

# Number of samples to use for LRU algorithm
maxmemory-samples 5

# ===========================================
# LOGGING
# ===========================================

# Log level: debug, verbose, notice, warning
loglevel notice

# Log file (empty for stdout)
logfile ""

# ===========================================
# DATABASES
# ===========================================

# Number of databases (0-15)
databases 16

# ===========================================
# SECURITY
# ===========================================

# Require AUTH (set password via environment variable)
# requirepass will be set via REDIS_PASSWORD env var

# Disable dangerous commands in production
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command KEYS ""

# ===========================================
# PERFORMANCE
# ===========================================

# Enable RDB/AOF compression
rdbcompression yes

# Stop writes if RDB snapshots fail
stop-writes-on-bgsave-error yes

# ===========================================
# RATE LIMITING OPTIMIZATIONS
# ===========================================

# Hash table optimization for small sets (good for rate limit counters)
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# Set table optimization
set-max-intset-entries 512

# Sorted set optimization (used by rate-limiter-flexible)
zset-max-ziplist-entries 128
zset-max-ziplist-value 64